<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AstroPipe.profile &mdash; AstroPipe 0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AstroPipe
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../AstroPipe.html">AstroPipe package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AstroPipe</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">AstroPipe.profile</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for AstroPipe.profile</h1><div class="highlight"><pre>
<span></span>


<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utilities</span> <span class="k">as</span> <span class="n">ut</span>
<span class="kn">from</span> <span class="nn">.plotting</span> <span class="kn">import</span> <span class="n">show</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">QTable</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.wcs.utils</span> <span class="kn">import</span> <span class="n">pixel_to_skycoord</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clip</span><span class="p">,</span> <span class="n">sigma_clipped_stats</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">ImageNormalize</span><span class="p">,</span><span class="n">LogStretch</span>

<span class="kn">from</span> <span class="nn">photutils.aperture</span> <span class="kn">import</span> <span class="n">EllipticalAperture</span><span class="p">,</span> <span class="n">EllipticalAnnulus</span>
<span class="kn">from</span> <span class="nn">photutils.isophote</span> <span class="kn">import</span> <span class="n">Ellipse</span><span class="p">,</span> <span class="n">EllipseGeometry</span>
<span class="kn">from</span> <span class="nn">photutils.aperture</span> <span class="kn">import</span> <span class="n">RectangularAperture</span>


<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patch</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">median_filter</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">medfilt</span><span class="p">,</span><span class="n">argrelextrema</span>


<span class="kn">from</span> <span class="nn">lmfit.models</span> <span class="kn">import</span> <span class="n">GaussianModel</span>

<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>



<span class="k">class</span> <span class="nc">Profile</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class to work with surface brightness profiles. </span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">        rad : array</span>
<span class="sd">            Radii of the profile in pixels</span>
<span class="sd">        int : array</span>
<span class="sd">            Intensity of the profile [in same units as image meassured]</span>
<span class="sd">        intstd : array</span>
<span class="sd">            Standard deviation of the intensity [int units]</span>
<span class="sd">        pa : array</span>
<span class="sd">            Position angle of the profile [deg]</span>
<span class="sd">        eps : array</span>
<span class="sd">            Ellipticity of the profile [1-b/a]</span>
<span class="sd">        center : 2d-array</span>
<span class="sd">            Center of the profile [pixels]</span>
<span class="sd">        bkg : float</span>
<span class="sd">            Background of the image [int units]</span>
<span class="sd">        bkgstd : float</span>
<span class="sd">            Standard deviation of the background [int units]</span>
<span class="sd">        zp : float</span>
<span class="sd">            Zero point of the image [mag]</span>
<span class="sd">        pixscale : float</span>
<span class="sd">            Pixel scale of the image [arcsec/pixel]</span>
<span class="sd">        mu : array</span>
<span class="sd">            surface brightness magnitude of the profile [mag*arcsec^-2]</span>
<span class="sd">        upperr : array</span>
<span class="sd">            Upper limit of the surface brightness magnitude [mag*arcsec^-2]</span>
<span class="sd">        lowerr : array</span>
<span class="sd">            Lower limit of the surface brightness magnitude [mag*arcsec^-2]</span>
<span class="sd">        columns : list</span>
<span class="sd">            List of the columns of the profile to be saved in table</span>
<span class="sd">        units : list</span>
<span class="sd">            List of the units of the columns</span>
<span class="sd">        meta : dict</span>
<span class="sd">            Dictionary of the metadata of the profile to be saved in table</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">        set_params(radii=None, intensity=None, instensity_err=None, pa=None, eps=None, center=None, bkg=None, bkgstd=None, zp=None, pixscale=None)</span>
<span class="sd">            Set the parameters of the profile</span>
<span class="sd">        </span>
<span class="sd">        load(filename)</span>
<span class="sd">            Load the profile from a file</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">max_radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_radius</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">growth_rate</span><span class="o">=</span><span class="mf">1.01</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">max_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">growth_rate</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">max_radius</span><span class="p">)</span><span class="o">//</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rad</span> <span class="o">=</span> <span class="n">init_radius</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">bkgstd</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">pixscale</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the average photometric radial profile in the array</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="n">array</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">hdu</span><span class="p">)</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="n">elliptical_radial_profile</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> 
                                    <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
        
        <span class="n">profile</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">bkg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span><span class="p">,</span> <span class="n">bkgstd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bkgstd</span><span class="p">,</span> 
                           <span class="n">zp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="n">pixscale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixscale</span><span class="p">)</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">brightness</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">profile</span>
    
    <span class="k">def</span> <span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">radii</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intensity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instensity_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">pa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bkg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bkgstd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pixscale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        
        <span class="k">if</span> <span class="n">radii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad</span> <span class="o">=</span> <span class="n">radii</span>
        <span class="k">if</span> <span class="n">intensity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int</span> <span class="o">=</span> <span class="n">intensity</span>
        
        <span class="c1"># This conversion variable is only to create arrays of static pa, eps, and center</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">conversion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;fixed&#39;</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">conversion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dynamic&#39;</span>
        
        <span class="k">if</span> <span class="n">instensity_err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intstd</span> <span class="o">=</span> <span class="n">instensity_err</span>
        
        <span class="k">if</span> <span class="n">pa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="o">*</span><span class="n">conversion</span>
        <span class="k">if</span> <span class="n">eps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span><span class="o">*</span><span class="n">conversion</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">conversion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">conversion</span>
        <span class="k">elif</span> <span class="n">center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">center</span>
        

        <span class="k">if</span> <span class="n">bkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="n">bkg</span>
        <span class="k">if</span> <span class="n">bkgstd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkgstd</span> <span class="o">=</span> <span class="n">bkgstd</span> 
        <span class="k">if</span> <span class="n">zp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span>
        <span class="k">if</span> <span class="n">pixscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixscale</span> <span class="o">=</span> <span class="n">pixscale</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity_err&#39;</span><span class="p">,</span> <span class="s1">&#39;pa&#39;</span><span class="p">,</span> <span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="s1">&#39;na&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel&#39;</span><span class="p">,</span><span class="s1">&#39;pixel&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;zp&#39;</span><span class="p">:</span><span class="n">zp</span><span class="p">,</span> <span class="s1">&#39;pixscale&#39;</span><span class="p">:</span><span class="n">pixscale</span><span class="p">,</span> <span class="s1">&#39;bkg&#39;</span><span class="p">:</span><span class="n">bkg</span> <span class="p">,</span> <span class="s1">&#39;bkgstd&#39;</span><span class="p">:</span><span class="n">bkgstd</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">zp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pixscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span><span class="p">()</span>
        
    
    <span class="k">def</span> <span class="nf">brightness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bkg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pixscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">bkgstd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">zp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zp</span> <span class="k">if</span> <span class="n">zp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">zp</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkg</span> <span class="k">if</span> <span class="n">bkg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bkg</span>
        <span class="n">bkgstd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkgstd</span> <span class="k">if</span> <span class="n">bkgstd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bkgstd</span>
        <span class="n">pixscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixscale</span> <span class="k">if</span> <span class="n">pixscale</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pixscale</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upperr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowerr</span> <span class="o">=</span> <span class="n">get_surface_brightness</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">intstd</span><span class="p">,</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">bkgstd</span><span class="p">,</span> <span class="n">pixscale</span><span class="p">,</span> <span class="n">zp</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">morphology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns the morphology of the profile</span>
<span class="sd">            at a surface brightness level&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;mu&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span><span class="p">()</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">closest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">[</span><span class="n">arg</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">arg</span><span class="o">+</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="n">arg</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">arg</span><span class="o">+</span><span class="mi">8</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">pa</span><span class="p">,</span> <span class="n">eps</span>
    
    <span class="k">def</span> <span class="nf">get_magnitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;TODO: Create function that computes the</span>
<span class="sd">        asymptotic magnitute of the profile</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">skycenter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">WCS</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">pixel_to_skycoord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">WCS</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">label</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixscale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upperr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowerr</span><span class="p">,</span> 
                           <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">growth_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Extends the radial profile to a new maximum radius&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">growth_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">growth_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">growth_rate</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">max_radius</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">//</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">new_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">new_prof</span> <span class="o">=</span> <span class="n">elliptical_radial_profile</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">new_rad</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="n">new_rad</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">new_prof</span><span class="o">.</span><span class="n">int</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">intstd</span><span class="p">,</span> <span class="n">new_prof</span><span class="o">.</span><span class="n">intstd</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">new_prof</span><span class="o">.</span><span class="n">pa</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">new_prof</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">new_prof</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">new_prof</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">remove_nans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intstd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intstd</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;zp&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">zp</span><span class="p">,</span> <span class="s1">&#39;pixscale&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixscale</span><span class="p">,</span> 
                     <span class="s1">&#39;bkg&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">bkg</span> <span class="p">,</span> <span class="s1">&#39;bkgstd&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkgstd</span><span class="p">}</span>
        
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;profile.txt&#39;</span>
        
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intstd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">],</span> 
                        <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                        <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;intensity_err&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)),</span> 
                        <span class="n">table</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;BKG&#39;</span><span class="p">],</span> <span class="n">table</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;BKGSTD&#39;</span><span class="p">],</span> <span class="n">table</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;ZP&#39;</span><span class="p">],</span> <span class="n">table</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;PIXSCALE&#39;</span><span class="p">])</span>
    

<span class="k">def</span> <span class="nf">plot_profile</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">mupper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mlower</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to plot the surface brightness profile of a galaxy</span>
<span class="sd">    and the elliptical parameters used in the photometry (eps and pa).</span>
<span class="sd">    It also plots the upper and lower limits of the profile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        radius : array</span>
<span class="sd">            Radius of the profile [arcsec]</span>
<span class="sd">        mu : array</span>
<span class="sd">            Surface brightness of the profile [mag*arcsec^-2]</span>
<span class="sd">        pa : float</span>
<span class="sd">            Position angle of the galaxy [deg]</span>
<span class="sd">        eps : float</span>
<span class="sd">            Ellipticity of the galaxy </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># if ax is None: fig,ax = plt.subplots(1,1)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">axeps</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">axmu</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">rowspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="n">axeps</span><span class="p">)</span>
    <span class="n">axpa</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="n">axeps</span><span class="p">)</span>
    

    <span class="c1"># Surface Brightness plot</span>
    <span class="n">axmu</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mupper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">axmu</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mupper</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mlower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">axmu</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mlower</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">axmu</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\mu\,[\mathrm{mag\,arcsec}^{-2}]$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">axmu</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

    <span class="c1"># Positional Angle plot</span>
    <span class="n">pa</span><span class="p">[</span><span class="n">pa</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="n">pa</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">]</span> <span class="o">-</span> <span class="mi">180</span>
    <span class="n">pa</span><span class="p">[</span><span class="n">pa</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="n">pa</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span>
    <span class="n">axpa</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">axpa</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PA (deg)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">axpa</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">190</span><span class="p">]);</span> <span class="n">axpa</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">180</span><span class="p">])</span>
    <span class="n">axpa</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">nbins</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">axpa</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="c1">#axpa.yaxis.set_label_position(&#39;right&#39;)</span>

    <span class="c1"># Epsilon plot</span>
    <span class="n">axeps</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">axeps</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">epsilon$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">axeps</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius (arcsec)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">axeps</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">1.1</span><span class="p">]);</span> <span class="n">axeps</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axeps</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">axmu</span><span class="p">,</span> <span class="n">axpa</span><span class="p">]:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">axmu</span><span class="p">,</span><span class="n">axpa</span><span class="p">,</span><span class="n">axeps</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span> <span class="nf">get_surface_brightness</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span>  <span class="n">intensitystd</span><span class="p">,</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">bkgstd</span><span class="p">,</span> <span class="n">pixscale</span><span class="p">,</span> <span class="n">zp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to calculate the surface brightness from the intensity.</span>
<span class="sd">    It also computes the lower and upper uncertanties due to the </span>
<span class="sd">    background and intensity std. It interpolates the nan values. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">intensity</span> <span class="o">-</span> <span class="n">bkg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pixscale</span><span class="p">)</span>
    <span class="n">lowerr</span> <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">intensity</span> <span class="o">-</span> <span class="n">bkg</span> <span class="o">+</span> <span class="n">intensitystd</span> <span class="o">+</span> <span class="n">bkgstd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pixscale</span><span class="p">)</span>
    <span class="n">upperr</span> <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">intensity</span> <span class="o">-</span> <span class="n">bkg</span> <span class="o">-</span> <span class="n">intensitystd</span> <span class="o">-</span> <span class="n">bkgstd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pixscale</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lowerr</span><span class="p">)):</span> <span class="n">lowerr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lowerr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lowerr</span><span class="p">)],</span> <span class="n">rad</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lowerr</span><span class="p">)],</span> <span class="n">lowerr</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lowerr</span><span class="p">)])</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">upperr</span><span class="p">)):</span> <span class="n">upperr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">upperr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">upperr</span><span class="p">)],</span> <span class="n">rad</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">upperr</span><span class="p">)],</span> <span class="n">upperr</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">upperr</span><span class="p">)])</span>
    <span class="n">maxdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mag</span><span class="o">-</span><span class="n">lowerr</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mag</span><span class="o">-</span><span class="n">upperr</span><span class="p">)])</span>
    <span class="n">upperr</span><span class="p">[</span><span class="n">upperr</span><span class="o">&lt;</span><span class="n">mag</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="n">upperr</span><span class="o">&lt;</span><span class="n">mag</span><span class="p">]</span> <span class="o">+</span> <span class="n">maxdiff</span>
    <span class="n">lowerr</span><span class="p">[</span><span class="n">lowerr</span><span class="o">&gt;</span><span class="n">mag</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="n">lowerr</span><span class="o">&gt;</span><span class="n">mag</span><span class="p">]</span> <span class="o">-</span> <span class="n">maxdiff</span>
    <span class="k">return</span> <span class="n">mag</span><span class="p">,</span> <span class="n">upperr</span><span class="p">,</span> <span class="n">lowerr</span>

<span class="k">def</span> <span class="nf">surface_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">growth_rate</span><span class="o">=</span><span class="mf">1.03</span><span class="p">,</span>
                        <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function that analyses the surface photometry of a galaxy image.</span>
<span class="sd">    TODO:It will:</span>
<span class="sd">        (1) Compute the morphological parameters, ellipticity and positon angle</span>
<span class="sd">        (2) Compute the background and radius where it reaches it</span>
<span class="sd">        (3) Compute three radial profiles:</span>
<span class="sd">            (3.1) Variable ishophotal radial profile</span>
<span class="sd">            (3.2) Fixed Elliptical radial profile</span>
<span class="sd">            (3.3) Rectangular radial profile</span>
<span class="sd">        (4) Small analysis to improve the profiles </span>
<span class="sd">        (5) Returns a table with the results</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">table</span>


<span class="k">def</span> <span class="nf">elliptical_radial_profile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">growth_rate</span><span class="o">=</span><span class="mf">1.03</span><span class="p">,</span>
                        <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sigma clipped average elliptical radial profile of a galaxy.</span>
<span class="sd">    It uses the elliptical apertures to get the radial profile.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        data : 2D array</span>
<span class="sd">            Image data.</span>
<span class="sd">        rad : array or float</span>
<span class="sd">            Radius of the apertures or maximum radius of aperture.</span>
<span class="sd">        center : tuple</span>
<span class="sd">            Center of the galaxy (x,y).</span>
<span class="sd">        pa : float</span>
<span class="sd">            Position angle of the galaxy.</span>
<span class="sd">        eps : float</span>
<span class="sd">            Ellipticity of the galaxy [1-b/a]</span>
<span class="sd">        max_r : float</span>
<span class="sd">            Maximum radius of the profile.</span>
<span class="sd">        growth_rate : float</span>
<span class="sd">            Growth rate of the apertures.</span>
<span class="sd">        plot : str</span>
<span class="sd">            If given it will save the plot in the given path.</span>
<span class="sd">        save : str</span>
<span class="sd">            If given it will save the profile in the given path.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        profile : AstroPipe.sbprofile.Profile</span>
<span class="sd">            Profile object with the radial profile.</span>
<span class="sd">   &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="n">max_radius</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span> <span class="n">growth_rate</span><span class="o">=</span><span class="n">growth_rate</span><span class="p">)</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">()</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">radii</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span>
                           <span class="n">intensity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rad</span><span class="p">),</span> <span class="n">instensity_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span>

    <span class="c1"># TODO: If keyword rad is givem maybe extrapolate pa, and eps¿?</span>
    <span class="c1"># if rad is not None:</span>
    <span class="c1">#     profile.pa = np.interp(rad, profile.rad, profile.pa)</span>
    <span class="c1">#     profile.eps = np.interp(rad, profile.eps, profile.eps)</span>
    <span class="c1">#     profile.set_params(center=(center[0], center[1]))</span>
    <span class="c1">#     profile.center = np.interp(rad, profile.rad, profile.center)</span>

    <span class="n">ellip_apertures</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">previous_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">rad</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ellip_apertures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">previous_mask</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="n">ellip_apertures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EllipticalAperture</span><span class="p">(</span>
            <span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">profile</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">rad</span><span class="p">,</span> 
            <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">profile</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">pa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>
        
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ellip_apertures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mask</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">previous_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">int</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">clipped</span><span class="p">)</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">intstd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">clipped</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">clipped</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">show</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ap</span> <span class="ow">in</span> <span class="n">ellip_apertures</span><span class="p">:</span>
            <span class="n">ap</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span><span class="n">lim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">profile</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">profile</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                            <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">]):</span>
            <span class="n">lim</span><span class="p">([</span><span class="n">val</span><span class="o">-</span><span class="mf">1.1</span><span class="o">*</span><span class="n">profile</span><span class="o">.</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="o">+</span><span class="mf">1.1</span><span class="o">*</span><span class="n">profile</span><span class="o">.</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_static.fits&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profile</span>


<span class="k">def</span> <span class="nf">isophotal_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">reff</span><span class="p">,</span>  <span class="n">max_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">growth_rate</span><span class="o">=</span><span class="mf">1.03</span><span class="p">,</span>
                        <span class="n">fix_center</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_pa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fix_eps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sigma clipped average radial profile of a galaxy.</span>
<span class="sd">    It uses the elliptical apertures to get the radial profile.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        data : 2D array</span>
<span class="sd">            Image data.</span>
<span class="sd">        center : tuple</span>
<span class="sd">            Center of the galaxy.</span>
<span class="sd">        pa : float</span>
<span class="sd">            Guess of the position angle of the galaxy.</span>
<span class="sd">        eps : float</span>
<span class="sd">            Guess ellipticity of the galaxy [1-b/a]</span>
<span class="sd">        max_r : float</span>
<span class="sd">            Maximum radius of the profile.</span>
<span class="sd">        growth_rate : float</span>
<span class="sd">            Growth rate of the apertures.</span>
<span class="sd">        plot : str</span>
<span class="sd">            If given it will save the plot in the given path.</span>
<span class="sd">        save : str</span>
<span class="sd">            If given it will save the profile in the given path.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        profile : AstroPipe.sbprofile.Profile</span>
<span class="sd">            Profile object with the radial profile.</span>
<span class="sd">   &#39;&#39;&#39;</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">growth_rate</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="n">guess_aper</span> <span class="o">=</span> <span class="n">EllipseGeometry</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y0</span><span class="o">=</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">sma</span><span class="o">=</span><span class="n">reff</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="p">)</span>


    <span class="n">ellipse</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">guess_aper</span><span class="p">)</span>

    <span class="n">isolist</span> <span class="o">=</span> <span class="n">ellipse</span><span class="o">.</span><span class="n">fit_image</span><span class="p">(</span><span class="n">reff</span><span class="p">,</span> <span class="n">integrmode</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span><span class="n">sclip</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">nclip</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxsma</span><span class="o">=</span><span class="n">max_r</span><span class="p">,</span>
                <span class="n">minsma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span><span class="n">fix_center</span><span class="o">=</span><span class="n">fix_center</span><span class="p">,</span><span class="n">fix_pa</span><span class="o">=</span><span class="n">fix_pa</span><span class="p">,</span><span class="n">fix_eps</span><span class="o">=</span><span class="n">fix_eps</span><span class="p">)</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">()</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">radii</span><span class="o">=</span><span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">intensity</span><span class="o">=</span><span class="n">isolist</span><span class="o">.</span><span class="n">intens</span><span class="p">,</span> <span class="n">instensity_err</span><span class="o">=</span><span class="n">isolist</span><span class="o">.</span><span class="n">int_err</span><span class="p">,</span>
        <span class="n">pa</span><span class="o">=</span><span class="n">isolist</span><span class="o">.</span><span class="n">pa</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">isolist</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">isolist</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">y0</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">show</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">rad</span><span class="p">):</span>
            <span class="n">ap</span> <span class="o">=</span> <span class="n">EllipticalAperture</span><span class="p">(</span>
            <span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">profile</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">rad</span><span class="p">,</span> 
            <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">profile</span><span class="o">.</span><span class="n">eps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">pa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">ap</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span><span class="n">lim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">profile</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">profile</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
                            <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">]):</span>
            <span class="n">lim</span><span class="p">([</span><span class="n">val</span><span class="o">-</span><span class="mf">1.1</span><span class="o">*</span><span class="n">max_r</span><span class="p">,</span><span class="n">val</span><span class="o">+</span><span class="mf">1.1</span><span class="o">*</span><span class="n">max_r</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_static.fits&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profile</span>


<span class="k">def</span> <span class="nf">rectangular_radial_profile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">growth_rate</span><span class="o">=</span><span class="mf">1.01</span><span class="p">,</span> 
                        <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sigma clipped average rectangular radial profile of a galaxy.</span>
<span class="sd">    It uses the rectangular apertures to get the radial profile.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        data : 2D array</span>
<span class="sd">            Image data.</span>
<span class="sd">        rad : array or float</span>
<span class="sd">            Radius of the apertures or maximum radius of aperture.</span>
<span class="sd">        center : tuple</span>
<span class="sd">            Center of the galaxy (x,y).</span>
<span class="sd">        pa : float</span>
<span class="sd">            Position angle of the galaxy.</span>
<span class="sd">        widht : float</span>
<span class="sd">            Width of the rectangular apertures.</span>
<span class="sd">        growth_rate : float</span>
<span class="sd">            Growth rate of the apertures.</span>
<span class="sd">        plot : str</span>
<span class="sd">            If given it will save the plot in the given path.</span>
<span class="sd">        save : str</span>
<span class="sd">            If given it will save the profile in the given path.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        profile : AstroPipe.sbprofile.Profile</span>
<span class="sd">            Profile object with the radial profile.</span>
<span class="sd">   &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="n">max_radius</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span> <span class="n">growth_rate</span><span class="o">=</span><span class="n">growth_rate</span><span class="p">)</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">()</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">radii</span><span class="o">=</span><span class="n">rad</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span>
                           <span class="n">intensity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rad</span><span class="p">),</span> <span class="n">instensity_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rad</span><span class="p">))</span>

    <span class="c1"># TODO: instead of fixed width apertures use increasingly large apertures to improve S/N at large radii</span>


    <span class="n">rect_apertures</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span> 

    <span class="n">previous_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">rad</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rect_apertures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">previous_mask</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">intstd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">rect_apertures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RectangularAperture</span><span class="p">(</span>
            <span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">profile</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">2</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pa</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">rect_apertures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mask</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">previous_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">int</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">clipped</span><span class="p">)</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">intstd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">clipped</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">clipped</span><span class="p">))</span>
        
        <span class="c1"># if np.nanmedian(profile.intstd[-1]) &gt; 3*std:</span>
        <span class="c1">#     width *= 1.5</span>
        <span class="c1">#     std = np.nanmedian(profile.intstd[-1])</span>

    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">show</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ap</span> <span class="ow">in</span> <span class="n">rect_apertures</span><span class="p">:</span>
            <span class="n">ap</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span><span class="n">lim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">profile</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">profile</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                            <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">]):</span>
            <span class="n">lim</span><span class="p">([</span><span class="n">val</span><span class="o">-</span><span class="mf">1.1</span><span class="o">*</span><span class="n">profile</span><span class="o">.</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="o">+</span><span class="mf">1.1</span><span class="o">*</span><span class="n">profile</span><span class="o">.</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_rectangular.fits&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profile</span>


<span class="k">def</span> <span class="nf">rectangular_photometry</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">zp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">growth_rate</span> <span class="o">=</span> <span class="mf">1.03</span><span class="p">,</span> <span class="n">max_r</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pa</span><span class="p">:</span> <span class="n">pa</span> <span class="o">=</span>  <span class="n">IMG</span><span class="o">.</span><span class="n">pa</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">center</span><span class="p">:</span> <span class="n">center</span> <span class="o">=</span> <span class="n">IMG</span><span class="o">.</span><span class="n">pix</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">zp</span><span class="p">:</span> <span class="n">zp</span> <span class="o">=</span> <span class="n">IMG</span><span class="o">.</span><span class="n">zp</span>

    
    <span class="n">data</span> <span class="o">=</span> <span class="n">IMG</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">IMG</span><span class="o">.</span><span class="n">bkg</span> 

    <span class="n">rect_apertures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">intensity_rec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">intensity_rec_std</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">previous_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">IMG</span><span class="o">.</span><span class="n">mu_to_counts</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">maglim</span><span class="p">)</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">IMG</span><span class="o">.</span><span class="n">mu_to_counts</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span><span class="n">stretch</span><span class="o">=</span><span class="n">LogStretch</span><span class="p">())</span>
        
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> 
                        <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;nipy_spectral_r&#39;</span><span class="p">)</span>
        
        <span class="n">bar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ticks</span><span class="o">=</span><span class="n">IMG</span><span class="o">.</span><span class="n">mu_to_counts</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="n">IMG</span><span class="o">.</span><span class="n">maglim</span><span class="p">,</span><span class="mf">2.5</span><span class="p">)))</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="n">IMG</span><span class="o">.</span><span class="n">maglim</span><span class="p">,</span><span class="mf">2.5</span><span class="p">))</span>
    
    <span class="n">sma</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">sma</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">max_r</span><span class="p">:</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rect_apertures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">previous_mask</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="n">rect_apertures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RectangularAperture</span><span class="p">((</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">sma</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pa</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">rect_apertures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span><span class="n">mask</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span><span class="n">previous_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">intensity_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
        <span class="n">intensity_rec_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">])))</span>
        <span class="n">radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sma</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sma</span> <span class="o">*=</span> <span class="n">growth_rate</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">rect_apertures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span> 
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">IMG</span><span class="o">.</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">max_r</span><span class="p">,</span><span class="n">IMG</span><span class="o">.</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">max_r</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">IMG</span><span class="o">.</span><span class="n">pix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">max_r</span><span class="p">,</span><span class="n">IMG</span><span class="o">.</span><span class="n">pix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">max_r</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


    <span class="n">sb_profile</span>  <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">intensity_rec</span><span class="p">,</span><span class="n">IMG</span><span class="o">.</span><span class="n">pixel_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">lower_err</span>   <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">intensity_rec</span><span class="p">,</span><span class="n">intensity_rec_std</span><span class="p">)</span><span class="o">/</span><span class="n">IMG</span><span class="o">.</span><span class="n">pixel_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
    <span class="n">upper_err</span>   <span class="o">=</span> <span class="n">zp</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">intensity_rec</span><span class="p">,</span><span class="n">intensity_rec_std</span><span class="p">)</span><span class="o">/</span><span class="n">IMG</span><span class="o">.</span><span class="n">pixel_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
    
    <span class="n">lower_err</span> <span class="o">=</span> <span class="n">sb_profile</span> <span class="o">-</span> <span class="n">lower_err</span> 
    <span class="n">upper_err</span> <span class="o">=</span> <span class="n">upper_err</span> <span class="o">-</span> <span class="n">sb_profile</span>  
    
    <span class="n">lower_err</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lower_err</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">lower_err</span><span class="p">)</span>
    <span class="n">upper_err</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">upper_err</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">upper_err</span><span class="p">)</span> 

    <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span><span class="o">*</span><span class="n">IMG</span><span class="o">.</span><span class="n">pixel_scale</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">([</span><span class="n">radii</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="p">,</span><span class="n">sb_profile</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mag</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                    <span class="n">lower_err</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mag</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">upper_err</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mag</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span><span class="s1">&#39;surface_brightness&#39;</span><span class="p">,</span><span class="s1">&#39;sb_err_low&#39;</span><span class="p">,</span><span class="s1">&#39;sb_err_upper&#39;</span><span class="p">],</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pixel_scale&#39;</span><span class="p">:</span><span class="n">IMG</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">,</span>
                    <span class="s1">&#39;zero_point&#39;</span><span class="p">:</span><span class="n">zp</span><span class="p">,</span>
                    <span class="s1">&#39;pa&#39;</span><span class="p">:</span><span class="n">pa</span><span class="p">,</span><span class="s1">&#39;width&#39;</span><span class="p">:</span><span class="n">width</span><span class="p">,</span>
                    <span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
    
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_rect.fits&#39;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">save</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_rectangles.jpg&#39;</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profile</span>

<span class="k">def</span> <span class="nf">random_rectangular_boxes</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">sma</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">wbox</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">ecc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">omegas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.9</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">sma</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">ecc</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omegas</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omegas</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omegas</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">dx</span><span class="p">,</span><span class="n">dy</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">change_coordinates</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span><span class="n">pa</span><span class="p">)</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="p">,</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dy</span><span class="p">])</span>
    
    <span class="n">rectangles</span> <span class="o">=</span> <span class="n">RectangularAperture</span><span class="p">(</span><span class="n">centers</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">wbox</span><span class="p">,</span> <span class="n">wbox</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rectangles</span>


<span class="k">def</span> <span class="nf">background_estimation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">growth_rate</span> <span class="o">=</span> <span class="mf">1.03</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Estimate the local background of a galaxy using elliptical apertures.</span>
<span class="sd">    </span>
<span class="sd">    It detects the maximum radius of the object containing signal with some </span>
<span class="sd">    statistical tests [bkg_radius]. Then rectangular apertures photometry</span>
<span class="sd">    to estimate the background value and its uncertainty. </span>
<span class="sd">    </span>
<span class="sd">    The apertures are created using the center, position angle, and ellipticity</span>
<span class="sd">    given. Then, the profile is meassure until certain radius. Once we reach </span>
<span class="sd">    intensity values close to the mode + sigma, we increase the resolution</span>
<span class="sd">    (growth_rate=1.01), and compute the smooth derivative of the profile. </span>
<span class="sd">    </span>
<span class="sd">    We stablish the value of the radius where the background is reach </span>
<span class="sd">    this conditions are met:</span>
<span class="sd">        </span>
<span class="sd">        - The derivative change its sign for more than five times </span>
<span class="sd">                This is a meassure of the fluctuation around dI = 0 </span>
<span class="sd">                when looking for a local assymptote.</span>
<span class="sd">        </span>
<span class="sd">        - Or when: I(r)/mode - 1 &lt; epsilon [epsilon = 0.1]</span>
<span class="sd">                Safe parameter to avoid infinite loops.</span>

<span class="sd">    TODO: To faster the process, first compute distances to mode </span>
<span class="sd">    +- sigma, and start in the closest or (q &gt; 25 ¿?), and maybe </span>
<span class="sd">    limit to (q &lt; 75 ¿?).</span>
<span class="sd">    </span>
<span class="sd">    TODO: first guess background with sigma clipping distribution, </span>
<span class="sd">    then do photometry with elliptical apertures increasing radius </span>
<span class="sd">    and check evidence of convergence (or Kolmogorov–Smirnov test)</span>
<span class="sd">    and stop when next aperture is not signficante more similar. </span>
<span class="sd">    Combine with current method.</span>

<span class="sd">    TODO: give option of sigma image to do statistical comparison of </span>
<span class="sd">    value optain with this, to see if the are of the same order, if not</span>
<span class="sd">    give warning.</span>

<span class="sd">    TODO: What is the best estimation of the uncertainty of the background</span>
<span class="sd">    meassure here?</span>
<span class="sd">        - Is it the std/np.sqrt(N_rect) </span>
<span class="sd">        - Is it the rms or rms normalize by the square root?</span>
<span class="sd">    Do tests to see which is the best.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        data : 2D numpy array</span>
<span class="sd">            Image of the galaxy.</span>
<span class="sd">        center : tuple</span>
<span class="sd">            Center of the galaxy in pixel coordinates.</span>
<span class="sd">        pa : float</span>
<span class="sd">            Position angle of the galaxy in degrees.</span>
<span class="sd">        eps : float</span>
<span class="sd">            Ellipticity of the galaxy. [1-b/a]</span>
<span class="sd">        growth_rate : float, optional</span>
<span class="sd">            Growth rate of the apertures. The default is 1.03.</span>
<span class="sd">        out : str, optional</span>
<span class="sd">            Path to save the background profile. The default is None.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Print the results. The default is False.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">        localsky : float</span>
<span class="sd">            Background value.</span>
<span class="sd">        localsky_std : float</span>
<span class="sd">            Background uncertainty.</span>
<span class="sd">        bkg_radius:  float</span>
<span class="sd">            Limiting radius where the background is reached.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span> <span class="c1"># convert to radians</span>
    
    <span class="c1"># First guess of the mode value</span>
    <span class="n">flatten</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">flatten</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">flatten</span><span class="p">)]</span>
    <span class="n">mode</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">find_mode</span><span class="p">(</span><span class="n">flatten</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>

    <span class="n">rad</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">intensity_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ellip_apertures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">previous_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">converge</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">maxr</span><span class="p">,</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mf">1e-1</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">converge</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ellip_apertures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">previous_mask</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="n">ellip_apertures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EllipticalAperture</span><span class="p">((</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span><span class="o">*</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pa</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ellip_apertures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">,</span><span class="n">mask</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span><span class="n">previous_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">intensity</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">clipped</span><span class="p">))</span>
        <span class="n">intensity_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity_std</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">clipped</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">clipped</span><span class="p">)))</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mode</span> <span class="o">+</span> <span class="n">std</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">maxr</span><span class="p">):</span>

            <span class="n">growth_rate</span> <span class="o">=</span> <span class="mf">1.01</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">intensity</span> <span class="o">&lt;</span> <span class="n">mode</span> <span class="o">+</span> <span class="n">std</span>
            <span class="n">dIdr</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">intensity</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="n">signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">dIdr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">/</span><span class="n">dIdr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">signs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">mode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">):</span>
                <span class="n">maxr</span> <span class="o">=</span> <span class="n">asymtotic_fit_radius</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">dIdr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;maxr=</span><span class="si">{</span><span class="n">maxr</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">; rad=</span><span class="si">{</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">; intesity=</span><span class="si">{</span><span class="n">intensity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.3</span><span class="o">*</span><span class="n">maxr</span><span class="p">:</span>
            <span class="n">converge</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">maxr</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rad</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">intensity</span><span class="p">))</span>
            <span class="k">break</span>

        <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">growth_rate</span><span class="p">)</span>


    <span class="n">dIdr</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">intensity</span><span class="p">)</span>
    <span class="n">ddIdr2</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">dIdr</span><span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="n">intensity</span> <span class="o">&lt;</span> <span class="n">mode</span> <span class="o">+</span> <span class="n">std</span>
    <span class="n">skyradius1</span> <span class="o">=</span> <span class="n">asymtotic_fit_radius</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">dIdr</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
    <span class="n">skyradius2</span> <span class="o">=</span> <span class="n">asymtotic_fit_radius</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">ddIdr2</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

    <span class="n">skyradii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">skyradius1</span><span class="p">,</span><span class="n">skyradius2</span><span class="p">])</span>
    <span class="n">aperfactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="mi">60</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">skyradii</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skyradii</span><span class="p">)),</span><span class="mi">3</span><span class="p">))])</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">skyradii</span><span class="p">),</span><span class="mi">60</span><span class="p">]))</span>


    <span class="n">bkg_aperture</span> <span class="o">=</span> <span class="n">EllipticalAnnulus</span><span class="p">((</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                     <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">aperfactor</span><span class="p">)</span><span class="o">*</span><span class="n">skyradii</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">aperfactor</span><span class="p">)</span><span class="o">*</span><span class="n">skyradii</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                    <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.6</span><span class="o">*</span><span class="n">eps</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">aperfactor</span><span class="p">)</span><span class="o">*</span><span class="n">skyradii</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">pa</span><span class="p">)</span>

    <span class="n">mask_aper</span> <span class="o">=</span> <span class="n">bkg_aperture</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">mask_aper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask_aper</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">mask_aper</span><span class="p">)</span>
    <span class="n">aper_values</span> <span class="o">=</span> <span class="n">data</span><span class="o">*</span><span class="n">mask_aper</span>
    <span class="n">aper_values</span> <span class="o">=</span> <span class="n">aper_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">aper_values</span><span class="o">.</span><span class="n">mask</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">localsky</span><span class="p">,</span> <span class="n">gauss_fit</span> <span class="o">=</span> <span class="n">find_mode</span><span class="p">(</span><span class="n">aper_values</span><span class="p">)</span>  


    <span class="c1"># Renctangular Apertures</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">random_rectangular_boxes</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="o">-</span><span class="n">pa</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">skyradii</span><span class="p">),</span> <span class="mf">0.6</span><span class="o">*</span><span class="n">eps</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">skyradii</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">width</span><span class="p">)),</span> <span class="n">wbox</span><span class="o">=</span><span class="n">width</span><span class="o">*</span><span class="mf">0.8</span><span class="p">)</span>

    <span class="n">res_stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rect</span><span class="p">:</span>
        <span class="n">mask_r</span> <span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">aper_val</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="o">~</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mask_r</span><span class="o">==</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">mean</span><span class="p">,</span><span class="n">med</span><span class="p">,</span><span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">aper_val</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">res_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">med</span><span class="p">)</span>

    <span class="n">localsky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">res_stats</span><span class="p">)</span>
    <span class="n">localsky_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">res_stats</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">res_stats</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
        <span class="n">ax4</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">rowspan</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">colspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">intensity</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (ADUs)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mode&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mode</span><span class="o">-</span><span class="n">std</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mode $\pm \sigma$&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mode</span><span class="o">+</span><span class="n">std</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">mode</span><span class="o">-</span><span class="n">std</span><span class="o">*</span><span class="mf">1.6</span><span class="p">,</span><span class="n">mode</span><span class="o">+</span><span class="n">std</span><span class="o">*</span><span class="mf">1.4</span><span class="p">])</span>
        <span class="n">arglim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">intensity</span><span class="o">-</span><span class="n">mode</span><span class="o">-</span><span class="n">std</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">rad</span><span class="p">[</span><span class="n">arglim</span><span class="p">],</span><span class="mf">1.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">skyradii</span><span class="p">))])</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">dIdr</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$dI/dr$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">skyradius2</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sign change&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">dIdr</span><span class="p">[</span><span class="n">arglim</span><span class="p">],</span><span class="o">-</span><span class="n">dIdr</span><span class="p">[</span><span class="n">arglim</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="p">])</span>

        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">ddIdr2</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$d^2I/dr^2$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius (pixels)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">skyradius1</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sign change&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="n">ddIdr2</span><span class="p">[</span><span class="n">arglim</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span><span class="n">ddIdr2</span><span class="p">[</span><span class="n">arglim</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">bkg_aperture</span><span class="o">.</span><span class="n">a_in</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sky annulus&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">bkg_aperture</span><span class="o">.</span><span class="n">a_out</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>       
        
        <span class="n">show</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">localsky</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">)</span>
        <span class="n">width</span><span class="o">=</span><span class="mf">1.2</span><span class="o">*</span><span class="n">skyradii</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="p">,</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">width</span><span class="p">])</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="p">,</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">width</span><span class="p">])</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
        <span class="n">bkg_aperture</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">localsky</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;localsky=</span><span class="si">{</span><span class="n">localsky</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
        <span class="n">rect</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">ax4</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">localsky</span><span class="p">,</span> <span class="n">localsky_std</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="n">rad</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">maxr</span><span class="p">]))</span>



<span class="k">def</span> <span class="nf">res_sum_squares</span><span class="p">(</span><span class="n">dmdr</span><span class="p">,</span> <span class="n">cog</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">abcissa</span><span class="p">):</span>

    <span class="n">y2</span> <span class="o">=</span> <span class="n">abcissa</span><span class="o">+</span><span class="n">slope</span><span class="o">*</span><span class="n">dmdr</span>    
    <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">cog</span><span class="o">-</span><span class="n">y2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">rms</span><span class="p">,</span> <span class="n">y2</span> 

<span class="k">def</span> <span class="nf">asymtotic_fit_radius</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find the asymptotic radius of a profile</span>
<span class="sd">    fitting a line and finding the intersection with the y axis</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">want</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">==</span> <span class="n">xx</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">want</span><span class="p">]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">want</span><span class="p">]</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
        <span class="n">rms</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">res_sum_squares</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># This was a custom function I wrote</span>
        <span class="n">want</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="o">*</span><span class="n">rms</span>
    
    <span class="k">return</span> <span class="o">-</span><span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Find radius where an asintote starts in a profile</span>
<span class="k">def</span> <span class="nf">find_radius_asintote</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="c1"># Find the first point where the slope of the line is 0</span>
    <span class="c1"># This is the point where the asintote starts</span>
    <span class="c1"># x,y are the profile</span>
    <span class="c1"># Returns the radius where the asintote starts</span>

    <span class="c1"># Find the slope of the line between each point</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># Find the first point where the slope is 0</span>
    <span class="c1"># This is the point where the asintote starts</span>
    <span class="c1"># This is the point where the slope changes sign</span>
    <span class="n">sign_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">slope</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Return the radius where the asintote starts</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">sign_change</span><span class="p">]</span>
    
<span class="k">def</span> <span class="nf">find_mode</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                         <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">median</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">median</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">std</span><span class="p">])</span>
    <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">bin_centers</span><span class="p">)</span>    

    <span class="k">return</span>  <span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">],</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes de slope from the n adjacent points using </span>
<span class="sd">    linear regression.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">deriv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
    
    <span class="n">der</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">],</span><span class="n">y</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">n</span><span class="p">:],</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">n</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">der</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope</span>
    <span class="n">deriv</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">der</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="o">~</span><span class="n">index</span><span class="p">):</span> <span class="n">deriv</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="k">return</span> <span class="n">deriv</span>



<span class="k">def</span> <span class="nf">aaron_break_finder</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the disk breaks in the surface brightness profile as </span>
<span class="sd">    seen in Watkins et al. (2019)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">mu</span><span class="o">&gt;</span><span class="nb">min</span><span class="p">,</span><span class="n">mu</span><span class="o">&lt;</span><span class="nb">max</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mu</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">der</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">rad</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">mu</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">der</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">der</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">cum_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">der</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">der</span><span class="p">))</span>
    <span class="n">maximum</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">cum_sum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">minimum</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">cum_sum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">critic</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maximum</span><span class="p">,</span><span class="n">minimum</span><span class="p">))</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">critic</span><span class="p">:</span>
        <span class="n">arg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">closest</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="n">point</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arg</span>



<span class="k">def</span> <span class="nf">find_slope</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">smFac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Derive slope of surface brightness profile vs. radius using adjacent w data</span>
<span class="sd">    points.  Returns this and a median-smoothed version of it.</span>

<span class="sd">    Requires:</span>
<span class="sd">     - rad (numpy.array): radius array</span>
<span class="sd">     - mu (numpy.array): surface brightness array, in mags/arcsec^2</span>
<span class="sd">     - w (int): width of array segments used to calculate local slope</span>
<span class="sd">     - smFac (float): fraction of array used as smoothing kernel size</span>

<span class="sd">    Returns:</span>
<span class="sd">     - inrad (numpy.array): clipped radius array of proper size</span>
<span class="sd">     - smooth_h (numpy.array): median filtered local scale lengths</span>
<span class="sd">     - h (numpy.array): unfiltered local scale lengths</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">inrad</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="n">w</span><span class="p">:</span><span class="o">-</span><span class="n">w</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inrad</span><span class="p">)):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">==</span> <span class="n">inrad</span><span class="p">[</span><span class="n">r</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fit_rads</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="n">w</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
        <span class="n">fit_flux</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="n">w</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">fit_rads</span><span class="p">,</span> <span class="n">fit_flux</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
    <span class="n">kernel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">smFac</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kernel</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">smooth_m</span> <span class="o">=</span> <span class="n">medfilt</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">kernel</span><span class="p">))</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">1.0857</span><span class="o">/</span><span class="n">m</span>  <span class="c1"># Scale length</span>
    <span class="n">smooth_h</span> <span class="o">=</span> <span class="mf">1.0857</span><span class="o">/</span><span class="n">smooth_m</span>
    
    <span class="k">return</span> <span class="n">inrad</span><span class="p">,</span> <span class="n">smooth_h</span><span class="p">,</span> <span class="n">h</span>


<span class="k">def</span> <span class="nf">cusum_wat</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Cumulative sum of the difference from the mean.</span>
<span class="sd">    The minimum or maximum is the break point.</span>

<span class="sd">    Requires:</span>
<span class="sd">     - x (numpy.array): the array for which you want the CUSUM</span>

<span class="sd">    Returns:</span>
<span class="sd">     - s (numpy.array): the CUSUM of x</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xbar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">xbar</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">cusum</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Cumulative sum of the difference from the mean.</span>
<span class="sd">    The minimum or maximum is the break point.</span>

<span class="sd">    Requires:</span>
<span class="sd">     - x (numpy.array): the array for which you want the CUSUM</span>

<span class="sd">    Returns:</span>
<span class="sd">     - c (numpy.array): the CUSUM of x</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">c</span>

<span class="k">def</span> <span class="nf">change_point</span><span class="p">(</span><span class="n">inrad</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mf">1e5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Finding the change point of the radial slope profile using the method illustrated here:</span>
<span class="sd">    http://www.variation.com/cpa/tech/changepoint.html</span>

<span class="sd">    Requires:</span>
<span class="sd">     - inrad (numpy.array): clipped radius array output from find_slope()</span>
<span class="sd">     - h (numpy.array): a local slope array output from find_slope()</span>
<span class="sd">     - N (int): number of bootstrapping iterations for confidence estimate</span>

<span class="sd">    Returns:</span>
<span class="sd">     - i1 (int): index in inrad of change point</span>
<span class="sd">     - s (numpy.array): cumulative sum profile</span>
<span class="sd">     - conf (float): percentage of bootstrapping runs in which a break was found</span>

<span class="sd">    NOTE: can use either h or smooth_h; whichever you feel does the better job</span>
<span class="sd">    NOTE2: for confidence estimate, consider also applying the</span>
<span class="sd">    criterion that the break must occur in the same general place in</span>
<span class="sd">    the array, to enhance robustness.  Not currently implemented.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">cusum</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="c1"># Amplitude of the break</span>
    <span class="n">sdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    
    <span class="c1"># Confidence estimate by bootstrapping</span>
    <span class="c1"># print(&#39;Bootstrapping...&#39;)</span>
    <span class="n">bs_sdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">N</span><span class="p">)):</span>
        <span class="n">randi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="n">randh</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">randi</span><span class="p">]</span>
        <span class="n">rands</span> <span class="o">=</span> <span class="n">cusum</span><span class="p">(</span><span class="n">randh</span><span class="p">)</span>
        <span class="n">randsdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rands</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rands</span><span class="p">)</span>
        <span class="n">bs_sdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bs_sdiff</span><span class="p">,</span> <span class="n">randsdiff</span><span class="p">)</span>
    <span class="n">good</span> <span class="o">=</span> <span class="n">bs_sdiff</span> <span class="o">&lt;</span> <span class="n">sdiff</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">[</span><span class="n">good</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">)</span>
    
    <span class="c1"># Location estimate one: maximum in s</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">s</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">i1</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">conf</span>


<span class="k">def</span> <span class="nf">find_all_breaks</span><span class="p">(</span><span class="n">inrad</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">rin</span><span class="p">,</span> <span class="n">rout</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tailored to find a maximum of three breaks across the disk.  Will</span>
<span class="sd">    require manual adjustment to find more than this.</span>

<span class="sd">    Requires:</span>
<span class="sd">     - inrad (numpy.array): clipped radius array output from find_slope()</span>
<span class="sd">     - h (numpy.array): a local slope array output from find_slope()</span>
<span class="sd">     - rin (float): inner radius boundary for searching for breaks</span>
<span class="sd">     - rout (float): outer radius boundary for searching for breaks</span>

<span class="sd">    Returns:</span>
<span class="sd">     - rbr1, rbr2, rbr3 (float): the three break radii the routine</span>
<span class="sd">       found, in the same units as inrad array</span>

<span class="sd">    NOTE: if a break wasn&#39;t found to be significant, this returns -999</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">want</span> <span class="o">=</span> <span class="p">(</span><span class="n">inrad</span> <span class="o">&gt;=</span> <span class="n">rin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">inrad</span> <span class="o">&lt;=</span> <span class="n">rout</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
    <span class="n">goodrad</span> <span class="o">=</span> <span class="n">inrad</span><span class="p">[</span><span class="n">want</span><span class="p">]</span>
    <span class="n">goodh</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">want</span><span class="p">]</span>
    
    <span class="c1"># First run, find if there&#39;s a global break</span>
    <span class="n">ig</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">confg</span> <span class="o">=</span> <span class="n">change_point</span><span class="p">(</span><span class="n">goodrad</span><span class="p">,</span> <span class="n">goodh</span><span class="p">)</span>
    <span class="c1"># Check confidence; if less than 95% of bootstrap runs found a</span>
    <span class="c1"># break, the global break isn&#39;t significant, so it doesn&#39;t bother to</span>
    <span class="c1"># look for any beyond that.</span>
    <span class="k">if</span> <span class="n">confg</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No breaks found&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">999</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rbr2</span> <span class="o">=</span> <span class="n">goodrad</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span>
        <span class="n">want_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">goodrad</span> <span class="o">&lt;</span> <span class="n">rbr2</span><span class="p">)</span>
        <span class="n">want_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">goodrad</span> <span class="o">&gt;</span> <span class="n">rbr2</span><span class="p">)</span>
        <span class="n">i_in</span><span class="p">,</span> <span class="n">s_in</span><span class="p">,</span> <span class="n">conf_in</span> <span class="o">=</span> <span class="n">change_point</span><span class="p">(</span><span class="n">goodrad</span><span class="p">[</span><span class="n">want_in</span><span class="p">],</span> <span class="n">goodh</span><span class="p">[</span><span class="n">want_in</span><span class="p">])</span>
        <span class="n">i_out</span><span class="p">,</span> <span class="n">s_out</span><span class="p">,</span> <span class="n">conf_out</span> <span class="o">=</span> <span class="n">change_point</span><span class="p">(</span><span class="n">goodrad</span><span class="p">[</span><span class="n">want_out</span><span class="p">],</span> <span class="n">goodh</span><span class="p">[</span><span class="n">want_out</span><span class="p">])</span>
        <span class="c1"># print(&#39;Initial guess: &#39;,goodrad[want_in][i_in], goodrad[ig], goodrad[want_out][i_out])</span>
        <span class="c1"># Same here: always using 95% confidence threshold (p-value = 0.05)</span>
        <span class="k">if</span> <span class="n">conf_in</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">:</span>
            <span class="n">rbr1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rbr1</span> <span class="o">=</span> <span class="n">goodrad</span><span class="p">[</span><span class="n">want_in</span><span class="p">][</span><span class="n">i_in</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">conf_out</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">:</span>
            <span class="n">rbr3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rbr3</span> <span class="o">=</span> <span class="n">goodrad</span><span class="p">[</span><span class="n">want_out</span><span class="p">][</span><span class="n">i_out</span><span class="p">]</span>
            
        <span class="c1"># print(conf_in, confg, conf_out)</span>
        <span class="k">return</span> <span class="n">rbr1</span><span class="p">,</span> <span class="n">rbr2</span><span class="p">,</span> <span class="n">rbr3</span>

<span class="k">def</span> <span class="nf">break_estimation</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">skyrms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
        <span class="n">rin</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">rout</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">npx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">zp</span><span class="o">=</span><span class="mf">22.5</span> <span class="p">,</span> <span class="n">pixel_scale</span><span class="o">=</span><span class="mf">0.333</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Estimate three different break in a surface brightness radial profile.</span>
<span class="sd">    The consistance of the breaks are also estimated by adding noise to the profile. </span>
<span class="sd">    Requires:</span>
<span class="sd">     - radius (numpy.array): radius array in arcsec</span>
<span class="sd">     - mu (numpy.array): mu array in counts</span>
<span class="sd">     - std (numpy.array): std array in counts</span>
<span class="sd">     - skyrms (float): sky rms level in counts</span>
<span class="sd">     - npx (int): number of pixels in the image</span>
<span class="sd">     - zp (float): zeropoint of the image</span>
<span class="sd">     - pixel_scale (float): pixel scale in arcsec/pixel</span>
<span class="sd">    Returns:</span>
<span class="sd">     - rbr (float): break radius in arcsec</span>
<span class="sd">     - rbr_err (float): error on break radius in arcsec</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">skyrms</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">npx</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">rms</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,(</span><span class="n">zp</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">inrad</span><span class="p">,</span> <span class="n">smooth_h</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">find_slope</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>

    <span class="n">mu_up</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">intensity</span><span class="o">+</span><span class="n">sig</span><span class="p">)</span> <span class="o">+</span> <span class="n">zp</span>
    <span class="n">mu_up</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mu_up</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    <span class="n">inrad_up</span><span class="p">,</span> <span class="n">smooth_h_up</span><span class="p">,</span> <span class="n">h_up</span> <span class="o">=</span> <span class="n">find_slope</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mu_up</span><span class="p">)</span>

    <span class="n">mu_down</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">intensity</span><span class="o">+</span><span class="n">sig</span><span class="p">)</span> <span class="o">+</span> <span class="n">zp</span>
    <span class="n">mu_down</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mu_down</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    <span class="n">inrad_down</span><span class="p">,</span> <span class="n">smooth_h_down</span><span class="p">,</span> <span class="n">h_down</span> <span class="o">=</span> <span class="n">find_slope</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mu_down</span><span class="p">)</span>

    
    <span class="c1"># Unaltered profile</span>
    <span class="n">rbr1</span><span class="p">,</span> <span class="n">rbr2</span><span class="p">,</span> <span class="n">rbr3</span> <span class="o">=</span> <span class="n">find_all_breaks</span><span class="p">(</span><span class="n">inrad</span><span class="p">,</span> <span class="n">smooth_h</span><span class="p">,</span> <span class="n">rin</span><span class="p">,</span> <span class="n">rout</span><span class="p">)</span>
    <span class="c1"># First sky perturbation</span>
    <span class="n">rbr1_up</span><span class="p">,</span> <span class="n">rbr2_up</span><span class="p">,</span> <span class="n">rbr3_up</span> <span class="o">=</span> <span class="n">find_all_breaks</span><span class="p">(</span><span class="n">inrad_up</span><span class="p">,</span> <span class="n">smooth_h_up</span><span class="p">,</span> <span class="n">rin</span><span class="p">,</span> <span class="n">rout</span><span class="p">)</span>
    <span class="c1"># Second sky perturbation</span>
    <span class="n">rbr1_down</span><span class="p">,</span> <span class="n">rbr2_down</span><span class="p">,</span> <span class="n">rbr3_down</span> <span class="o">=</span> <span class="n">find_all_breaks</span><span class="p">(</span><span class="n">inrad_down</span><span class="p">,</span> <span class="n">smooth_h_down</span><span class="p">,</span> <span class="n">rin</span><span class="p">,</span> <span class="n">rout</span><span class="p">)</span>

    <span class="n">rbr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rbr1</span><span class="p">,</span><span class="n">rbr2</span><span class="p">,</span><span class="n">rbr3</span><span class="p">,</span>
                    <span class="n">rbr1_up</span><span class="p">,</span><span class="n">rbr2_up</span><span class="p">,</span><span class="n">rbr3_up</span><span class="p">,</span>
                    <span class="n">rbr1_down</span><span class="p">,</span><span class="n">rbr2_down</span><span class="p">,</span><span class="n">rbr3_down</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">rbr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rbr</span><span class="p">[</span><span class="n">rbr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">999</span><span class="p">,</span><span class="o">-</span><span class="mi">999</span><span class="p">,</span><span class="o">-</span><span class="mi">999</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">centers</span>



<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">photutils.isophote.geometry</span> <span class="kn">import</span> <span class="n">EllipseGeometry</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;build_ellipse_model&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="build_ellipse_model">
<a class="viewcode-back" href="../../AstroPipe.html#AstroPipe.profile.build_ellipse_model">[docs]</a>
<span class="k">def</span> <span class="nf">build_ellipse_model</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">isolist</span><span class="p">,</span><span class="n">intensity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">high_harmonics</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a model elliptical galaxy image from a list of isophotes.</span>

<span class="sd">    For each ellipse in the input isophote list the algorithm fills the</span>
<span class="sd">    output image array with the corresponding isophotal intensity.</span>
<span class="sd">    Pixels in the output array are in general only partially covered by</span>
<span class="sd">    the isophote &quot;pixel&quot;.  The algorithm takes care of this partial</span>
<span class="sd">    pixel coverage by keeping track of how much intensity was added to</span>
<span class="sd">    each pixel by storing the partial area information in an auxiliary</span>
<span class="sd">    array.  The information in this array is then used to normalize the</span>
<span class="sd">    pixel intensities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape : 2-tuple</span>
<span class="sd">        The (ny, nx) shape of the array used to generate the input</span>
<span class="sd">        ``isolist``.</span>

<span class="sd">    isolist : `~photutils.isophote.IsophoteList` instance</span>
<span class="sd">        The isophote list created by the `~photutils.isophote.Ellipse`</span>
<span class="sd">        class.</span>

<span class="sd">    fill : float, optional</span>
<span class="sd">        The constant value to fill empty pixels. If an output pixel has</span>
<span class="sd">        no contribution from any isophote, it will be assigned this</span>
<span class="sd">        value.  The default is 0.</span>

<span class="sd">    high_harmonics : bool, optional</span>
<span class="sd">        Whether to add the higher-order harmonics (i.e., ``a3``, ``b3``,</span>
<span class="sd">        ``a4``, and ``b4``; see `~photutils.isophote.Isophote` for</span>
<span class="sd">        details) to the result.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : 2D `~numpy.ndarray`</span>
<span class="sd">        The image with the model galaxy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">LSQUnivariateSpline</span>

    <span class="c1"># the target grid is spaced in 0.1 pixel intervals so as</span>
    <span class="c1"># to ensure no gaps will result on the output array.</span>
    <span class="n">finely_spaced_sma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">isolist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">intensity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">isolist</span><span class="o">.</span><span class="n">intens</span> 
    <span class="c1"># interpolate ellipse parameters</span>

    <span class="c1"># End points must be discarded, but how many?</span>
    <span class="c1"># This seems to work so far</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">intens_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>
    <span class="n">eps_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>
    <span class="n">pa_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>
    <span class="n">x0_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>
    <span class="n">y0_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>
    <span class="n">grad_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>
    <span class="n">a3_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">a3</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>
    <span class="n">b3_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">b3</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>
    <span class="n">a4_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">a4</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>
    <span class="n">b4_array</span> <span class="o">=</span> <span class="n">LSQUnivariateSpline</span><span class="p">(</span>
        <span class="n">isolist</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="n">isolist</span><span class="o">.</span><span class="n">b4</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)(</span><span class="n">finely_spaced_sma</span><span class="p">)</span>

    <span class="c1"># Return deviations from ellipticity to their original amplitude meaning</span>
    <span class="n">a3_array</span> <span class="o">=</span> <span class="o">-</span><span class="n">a3_array</span> <span class="o">*</span> <span class="n">grad_array</span> <span class="o">*</span> <span class="n">finely_spaced_sma</span>
    <span class="n">b3_array</span> <span class="o">=</span> <span class="o">-</span><span class="n">b3_array</span> <span class="o">*</span> <span class="n">grad_array</span> <span class="o">*</span> <span class="n">finely_spaced_sma</span>
    <span class="n">a4_array</span> <span class="o">=</span> <span class="o">-</span><span class="n">a4_array</span> <span class="o">*</span> <span class="n">grad_array</span> <span class="o">*</span> <span class="n">finely_spaced_sma</span>
    <span class="n">b4_array</span> <span class="o">=</span> <span class="o">-</span><span class="n">b4_array</span> <span class="o">*</span> <span class="n">grad_array</span> <span class="o">*</span> <span class="n">finely_spaced_sma</span>

    <span class="c1"># correct deviations cased by fluctuations in spline solution</span>
    <span class="n">eps_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eps_array</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">eps_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eps_array</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.05</span>

    <span class="c1"># for each interpolated isophote, generate intensity values on the</span>
    <span class="c1"># output image array</span>
    <span class="c1"># for index in range(len(finely_spaced_sma)):</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">finely_spaced_sma</span><span class="p">)):</span>
        <span class="n">sma0</span> <span class="o">=</span> <span class="n">finely_spaced_sma</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">eps_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">pa_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x0_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">y0_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">EllipseGeometry</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">sma0</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">pa</span><span class="p">)</span>

        <span class="n">intens</span> <span class="o">=</span> <span class="n">intens_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># scan angles. Need to go a bit beyond full circle to ensure</span>
        <span class="c1"># full coverage.</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">sma0</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">while</span> <span class="n">phi</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">geometry</span><span class="o">.</span><span class="n">_phi_min</span><span class="p">:</span>
            <span class="c1"># we might want to add the third and fourth harmonics</span>
            <span class="c1"># to the basic isophotal intensity.</span>
            <span class="n">harm</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">if</span> <span class="n">high_harmonics</span><span class="p">:</span>
                <span class="n">harm</span> <span class="o">=</span> <span class="p">(</span><span class="n">a3_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">b3_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">a4_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">b4_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span> <span class="o">/</span> <span class="mf">4.</span>

            <span class="c1"># get image coordinates of (r, phi) pixel</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span> <span class="o">+</span> <span class="n">pa</span><span class="p">)</span> <span class="o">+</span> <span class="n">x0</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span> <span class="o">+</span> <span class="n">pa</span><span class="p">)</span> <span class="o">+</span> <span class="n">y0</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># get fractional deviations relative to target array</span>
                <span class="n">fx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">fy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

                <span class="c1"># add up the isophote contribution to the overlapping pixels</span>
                <span class="n">result</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">intens</span> <span class="o">+</span> <span class="n">harm</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fy</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fx</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">intens</span> <span class="o">+</span> <span class="n">harm</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fy</span><span class="p">)</span> <span class="o">*</span> <span class="n">fx</span>
                <span class="n">result</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">intens</span> <span class="o">+</span> <span class="n">harm</span><span class="p">)</span> <span class="o">*</span> <span class="n">fy</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fx</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">intens</span> <span class="o">+</span> <span class="n">harm</span><span class="p">)</span> <span class="o">*</span> <span class="n">fy</span> <span class="o">*</span> <span class="n">fx</span>

                <span class="c1"># add up the fractional area contribution to the</span>
                <span class="c1"># overlapping pixels</span>
                <span class="n">weight</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fy</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fx</span><span class="p">)</span>
                <span class="n">weight</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fy</span><span class="p">)</span> <span class="o">*</span> <span class="n">fx</span>
                <span class="n">weight</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fy</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fx</span><span class="p">)</span>
                <span class="n">weight</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fy</span> <span class="o">*</span> <span class="n">fx</span>

                <span class="c1"># step towards next pixel on ellipse</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">phi</span> <span class="o">+</span> <span class="mf">0.75</span> <span class="o">/</span> <span class="n">r</span><span class="p">),</span> <span class="n">geometry</span><span class="o">.</span><span class="n">_phi_min</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">radius</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="c1"># if outside image boundaries, ignore.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="c1"># zero weight values must be set to 1.</span>
    <span class="n">weight</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weight</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="c1"># normalize</span>
    <span class="n">result</span> <span class="o">/=</span> <span class="n">weight</span>

    <span class="c1"># fill value</span>
    <span class="n">result</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fill</span>

    <span class="k">return</span> <span class="n">result</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Pablo M. Sánchez-Alarcón.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>